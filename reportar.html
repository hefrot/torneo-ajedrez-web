<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reportar Resultado • Torneo</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
  <script defer src="https://kit.fontawesome.com/a2e0e6ad4d.js" crossorigin="anonymous"></script>
  <style>.wrap{max-width:980px;margin:0 auto}.panel{background:linear-gradient(180deg, rgba(21,29,47,.9), rgba(21,29,47,.78));border:1px solid var(--line);border-radius:16px;padding:16px}.toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px}.search{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px 12px;background:rgba(21,29,47,.6)}.search input{border:0;outline:none;background:transparent;color:var(--text);min-width:240px}.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}.muted{color:var(--muted)}select,input[type='text']{padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:rgba(21,29,47,.6);color:var(--text);width:100%}.kv{display:flex;justify-content:space-between;margin:6px 0}.banner{padding:10px 12px;border-radius:10px;background:#4b1f1f;border:1px solid #ff6b6b;color:#fff;margin-bottom:12px;display:none}.ok{background:#153b2b;border-color:#2ecc71}</style>
</head>
<body>
  <header class="header">
    <div class="header-inner container">
      <div class="logo"></div>
      <div class="title"><div class="badge">Resultados</div><h1 class="title">Reportar Resultado (BO3, 3 juegos obligatorios)</h1></div>
      <div class="header-stats" style="margin-left:auto">
        <a class="pill" href="./index.html"><i class="fa-solid fa-arrow-left"></i> <span>Inicio</span></a>
        <a class="pill" href="./calendario.html"><i class="fa-solid fa-calendar"></i> <span>Calendario</span></a>
      </div>
    </div>
  </header>
  <main class="container">
    <div class="wrap">
      <div id="authError" class="banner"></div>
      <section class="section panel">
        <h2 style="margin-top:0">Selecciona tu partida</h2>
        <div class="toolbar">
          <div class="search"><i class="fa-solid fa-magnifying-glass"></i><input id="q" placeholder="Buscar jugador (tu nombre o el de tu rival)"></div>
          <div class="input"><label class="small muted">Ronda</label><select id="roundSelect"></select></div>
          <div class="input"><label class="small muted">Partida</label><select id="matchSelect"></select></div>
        </div>
        <div class="muted">La lista se llena desde <code>/calendario</code>. Al guardar, se crea/actualiza <code>/pairings</code>.</div>
      </section>
      <section class="section panel">
        <h2 style="margin-top:0">Marcadores por juego (obligatorios)</h2>
        <div class="row-3">
          <div class="input"><label class="small muted">Juego 1</label><select id="g1" required><option value="">—</option></select></div>
          <div class="input"><label class="small muted">Juego 2</label><select id="g2" required><option value="">—</option></select></div>
          <div class="input"><label class="small muted">Juego 3</label><select id="g3" required><option value="">—</option></select></div>
        </div>
        <div class="muted" id="roundWarning"></div>
        <div class="row" style="margin-top:12px">
          <div class="input"><label class="small muted">Reportado por (nombre)</label><input id="reporter" type="text" placeholder="Tu nombre y apellido"></div>
          <div class="input"><label class="small muted">Comentario (opcional)</label><input id="note" type="text" placeholder="Algún detalle (no obligatorio)"></div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;margin-top:16px"><button id="btn-save" class="btn primary">Guardar resultado</button><div id="saveStatus" class="muted"></div></div>
      </section>
      <section class="section panel"><h2 style="margin-top:0">Vista previa</h2><div id="preview" class="muted">Selecciona una partida para ver el detalle.</div></section>
    </div>
  </main>
  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    const app = initializeApp(firebaseConfig); const auth=getAuth(app); const db=getDatabase(app);
    const Q=document.getElementById('q'); const ROUND=document.getElementById('roundSelect'); const MATCH=document.getElementById('matchSelect');
    const G1=document.getElementById('g1'), G2=document.getElementById('g2'), G3=document.getElementById('g3');
    const BTN_SAVE=document.getElementById('btn-save'); const STATUS=document.getElementById('saveStatus'); const PREVIEW=document.getElementById('preview');
    const REPORTER=document.getElementById('reporter'); const NOTE=document.getElementById('note'); const AUTH_ERR=document.getElementById('authError'); const WARN=document.getElementById('roundWarning');
    let uid=null, calendario={}, pairingsById={}, matchLookup={}, schedule={};
    const norm=s=>String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); const vsLabel=(w,b)=>`${w} vs ${b}`;
    function calcWinner(g1,g2,g3){ const pts={white:0,black:0}; for(const g of [g1,g2,g3]){ if(!g) return null; if(g==='white') pts.white+=1; else if(g==='black') pts.black+=1; else if(g==='draw'){ pts.white+=0.5; pts.black+=0.5; } } if(pts.white>pts.black) return 'white'; if(pts.black>pts.white) return 'black'; return 'draw'; }
    function safeKey(s){ return norm(s).replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,''); }
    function makePairKey(round, white, black){ const a=safeKey(white), b=safeKey(black); const [x,y]=[a,b].sort(); return `r${round}_${x}__${y}`; }
    function findExistingPair(round, white, black){ const A=norm(white), B=norm(black); for(const [id,p] of Object.entries(pairingsById)){ if(Number(p.round)!==Number(round)) continue; const pw=norm(p.white||''), pb=norm(p.black||''); if((pw===A && pb===B) || (pw===B && pb===A)) return id; } return null; }
    function rondaCerrada(r){ const end=schedule[String(r)]?.endAt||null; return end ? (Date.now()>end) : false; }
    function setGameLabels(whiteName, blackName){ const opts=[{v:'white',text:`Ganó ${whiteName}`},{v:'black',text:`Ganó ${blackName}`},{v:'draw',text:`Empate`}]; [G1,G2,G3].forEach(sel=>{ const cur=sel.value||''; sel.innerHTML=`<option value="">—</option>`+opts.map(o=>`<option value="${o.v}">${o.text}</option>`).join(''); if(cur) sel.value=cur; }); }
    function gameLabelHuman(g, w, b){ if(g==='white') return `${w} ganó`; if(g==='black') return `${b} ganó`; if(g==='draw') return `empate`; return '—'; }
    function renderHumanSummary(m){ const t1=gameLabelHuman(G1.value,m.white,m.black), t2=gameLabelHuman(G2.value,m.white,m.black), t3=gameLabelHuman(G3.value,m.white,m.black); PREVIEW.innerHTML=`<div class="kv"><span>Ronda</span><strong>${m.round}</strong></div><div class="kv"><span>Partida</span><strong>${m.white} vs ${m.black}</strong></div><div class="kv"><span>J1</span><strong>${t1}</strong></div><div class="kv"><span>J2</span><strong>${t2}</strong></div><div class="kv"><span>J3</span><strong>${t3}</strong></div>`; }
    signInAnonymously(auth).catch(e=>{ AUTH_ERR.style.display='block'; AUTH_ERR.innerHTML='⚠️ No se pudo iniciar sesión anónima. Habilita <b>Authentication → Anonymous</b> en Firebase.<br><small>'+e.code+'</small>'; });
    onAuthStateChanged(auth,user=>{ uid=user?.uid||null; if(uid){ AUTH_ERR.style.display='none'; AUTH_ERR.textContent=''; } });
    onValue(ref(db,'tournament/rounds'), s=>{ schedule=s.val()||{}; });
    onValue(ref(db,'calendario'), s=>{ calendario=s.val()||{}; renderRounds(); renderMatches(); });
    onValue(ref(db,'pairings'),   s=>{ pairingsById=s.val()||{}; renderRounds(); renderMatches(); });
    function renderRounds(){ const rounds=Object.keys(calendario).filter(k=>/^ronda\d+$/i.test(k)).map(k=>Number(k.replace(/\D/g,''))).sort((a,b)=>a-b); ROUND.innerHTML=rounds.map(r=>`<option value="${r}">Ronda ${r}</option>`).join(''); if(!ROUND.value && rounds.length) ROUND.value=String(rounds[0]); }
    function renderMatches(){ const r=Number(ROUND.value); const key=`ronda${r}`; const list=calendario[key]||[]; const q=norm(Q.value); const filtered=q?list.filter(m=>norm(m.p1_name).includes(q)||norm(m.p2_name).includes(q)):list; matchLookup={}; MATCH.innerHTML=filtered.map(m=>{ const existingId=findExistingPair(r,m.p1_name,m.p2_name); const keyVal=existingId||makePairKey(r,m.p1_name,m.p2_name); matchLookup[keyVal]={round:r,white:m.p1_name,black:m.p2_name,pairingId:existingId||null}; const tag=existingId?'publicada':'nueva'; return `<option value="${keyVal}">${vsLabel(m.p1_name,m.p2_name)} — [${tag}]</option>`; }).join(''); renderPreview(); WARN.innerHTML=rondaCerrada(r)?'⏱️ <b>Ojo:</b> La ronda está <b>cerrada</b>. Aún puedes reportar, pero el organizador puede anular reportes tardíos.':''; }
    function renderPreview(){ const id=MATCH.value; if(!id){ PREVIEW.textContent='Selecciona una partida.'; return; } const m=matchLookup[id]; if(!m){ PREVIEW.textContent='Selecciona una partida.'; return; } let p=m.pairingId?pairingsById[m.pairingId]:null; setGameLabels(m.white,m.black); G1.value=p?.game1||''; G2.value=p?.game2||''; G3.value=p?.game3||''; renderHumanSummary(m); }
    [G1,G2,G3].forEach(sel=>{ sel.addEventListener('change',()=>{ const id=MATCH.value; if(!id) return; const m=matchLookup[id]; if(!m) return; renderHumanSummary(m); }); });
    BTN_SAVE.addEventListener('click', async ()=>{ STATUS.textContent=''; if(!uid){ AUTH_ERR.style.display='block'; AUTH_ERR.innerHTML='⚠️ No hay sesión activa. Recarga e intenta de nuevo. Si persiste, habilita Anonymous en Firebase.'; return; } const key=MATCH.value; if(!key){ STATUS.textContent='Selecciona una partida.'; return; } const m=matchLookup[key]; if(!m){ STATUS.textContent='Selecciona una partida válida.'; return; } const g1=G1.value, g2=G2.value, g3=G3.value; if(!g1||!g2||!g3){ STATUS.innerHTML='<span style="color:#ff6b6b">Debes seleccionar los 3 juegos (J1, J2, J3).</span>'; return; } const overall=calcWinner(g1,g2,g3); if(!overall){ STATUS.innerHTML='<span style="color:#ff6b6b">Completa todos los juegos para calcular el resultado global.</span>'; return; } const payloadBase={ white:m.white, black:m.black, round:m.round }; const payload={ ...payloadBase, game1:g1, game2:g2, game3:g3, result:overall, updatedAt:Date.now(), reportedBy:(REPORTER.value||'').trim()||null, note:(NOTE.value||'').trim()||null, reporterUid:uid||null }; try{ const path=`pairings/${m.pairingId||key}`; if(!m.pairingId) await set(ref(db,path), payloadBase); await update(ref(db,path), payload); STATUS.innerHTML='<span class="ok">✔️ Resultado guardado.</span>'; }catch(e){ console.error(e); const msg=e?.code==='PERMISSION_DENIED' ? 'Revisa las reglas de Realtime DB (".write": "auth != null") y Authentication: Anonymous habilitado.' : e.message; STATUS.innerHTML='<span style="color:#ff6b6b">Error: '+msg+'</span>'; } });
  </script>
</body>
</html>