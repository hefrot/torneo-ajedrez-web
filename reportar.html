<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reportar Resultado • Torneo</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
  <script defer src="https://kit.fontawesome.com/a2e0e6ad4d.js" crossorigin="anonymous"></script>
  <style>
    .wrap{max-width:980px;margin:0 auto}
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    .search{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px 12px;background:rgba(21,29,47,.6)}
    .search input{border:0;outline:none;background:transparent;color:var(--text);min-width:260px}
    .panel{background:linear-gradient(180deg, rgba(21,29,47,.9), rgba(21,29,47,.78));border:1px solid var(--line);border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:var(--muted)}
    select, input[type="text"]{padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:rgba(21,29,47,.6);color:var(--text);width:100%}
    .help{font-size:13px;color:var(--muted);margin-top:8px}
    .status-ok{color:var(--win)} .status-bad{color:var(--loss)}
    .pill{cursor:default}
    .kv{display:flex;justify-content:space-between;gap:10px;margin:6px 0}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner container">
      <div class="logo"></div>
      <div class="title">
        <div class="badge">Resultados</div>
        <h1 class="title">Reportar Resultado (BO3, 3 juegos obligatorios)</h1>
      </div>
      <div class="header-stats" style="margin-left:auto">
        <a class="pill" href="./index.html"><i class="fa-solid fa-arrow-left"></i> <span>Inicio</span></a>
        <a class="pill" href="./calendario.html"><i class="fa-solid fa-calendar"></i> <span>Calendario</span></a>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="wrap">
      <!-- SELECCIÓN DE PARTIDA -->
      <section class="section panel">
        <h2 style="margin-top:0">Selecciona tu partida</h2>
        <div class="toolbar">
          <div class="search">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="q" placeholder="Buscar jugador (tu nombre o el de tu rival)">
          </div>
          <div class="input">
            <label class="small muted">Ronda</label>
            <select id="roundSelect"></select>
          </div>
          <div class="input">
            <label class="small muted">Partida</label>
            <select id="matchSelect"></select>
          </div>
        </div>
        <div class="help">Tip: escribe tu apellido para filtrar rápido. Si no aparece tu partida en esta ronda, verifica que esté publicada en <code>/pairings</code>.</div>
      </section>

      <!-- MARCADORES OBLIGATORIOS -->
      <section class="section panel">
        <h2 style="margin-top:0">Marcadores por juego (obligatorios)</h2>
        <div class="row-3">
          <div class="input">
            <label class="small muted">Juego 1</label>
            <select id="g1" required>
              <option value="">—</option>
              <option value="white">1–0 (blancas)</option>
              <option value="black">0–1 (negras)</option>
              <option value="draw">½–½</option>
            </select>
          </div>
          <div class="input">
            <label class="small muted">Juego 2</label>
            <select id="g2" required>
              <option value="">—</option>
              <option value="white">1–0 (blancas)</option>
              <option value="black">0–1 (negras)</option>
              <option value="draw">½–½</option>
            </select>
          </div>
          <div class="input">
            <label class="small muted">Juego 3</label>
            <select id="g3" required>
              <option value="">—</option>
              <option value="white">1–0 (blancas)</option>
              <option value="black">0–1 (negras)</option>
              <option value="draw">½–½</option>
            </select>
          </div>
        </div>
        <div class="help">⚠️ En esta liga se juegan SIEMPRE los 3 juegos. El sistema no permite guardar si falta alguno.</div>

        <div class="row" style="margin-top:12px">
          <div class="input">
            <label class="small muted">Reportado por (nombre)</label>
            <input id="reporter" type="text" placeholder="Tu nombre y apellido">
          </div>
          <div class="input">
            <label class="small muted">Comentario (opcional)</label>
            <input id="note" type="text" placeholder="Algún detalle (no obligatorio)">
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-top:16px">
          <button id="btn-save" class="btn primary">Guardar resultado</button>
          <div id="saveStatus" class="muted"></div>
        </div>
      </section>

      <!-- VISTA PREVIA -->
      <section class="section panel">
        <h2 style="margin-top:0">Vista previa</h2>
        <div id="preview" class="muted">Selecciona una partida para ver el detalle.</div>
      </section>
    </div>
  </main>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // UI refs
    const Q = document.getElementById('q');
    const ROUND = document.getElementById('roundSelect');
    const MATCH = document.getElementById('matchSelect');
    const G1 = document.getElementById('g1');
    const G2 = document.getElementById('g2');
    const G3 = document.getElementById('g3');
    const BTN_SAVE = document.getElementById('btn-save');
    const STATUS = document.getElementById('saveStatus');
    const PREVIEW = document.getElementById('preview');
    const REPORTER = document.getElementById('reporter');
    const NOTE = document.getElementById('note');

    // Auth anónima (para permitir escritura si rules requieren auth != null)
    let uid = null;
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user)=>{ uid = user?.uid || null; });

    // Estado
    let allPairings = {};
    let allRounds = [];
    let filteredIds = [];

    // Utils
    function norm(s){ return String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }
    function vsLabel(p){ return `${p.white} vs ${p.black}`; }
    function calcWinner(g1,g2,g3){
      const pts = { white:0, black:0 };
      for(const g of [g1,g2,g3]){
        if(!g) return null; // falta alguno
        if(g==='white') pts.white+=1;
        else if(g==='black') pts.black+=1;
        else if(g==='draw'){ pts.white+=0.5; pts.black+=0.5; }
      }
      if(pts.white>pts.black) return 'white';
      if(pts.black>pts.white) return 'black';
      return 'draw';
    }

    // Render helpers
    function renderRounds(){
      const set = new Set(Object.values(allPairings).map(p=> Number(p.round||0)));
      allRounds = Array.from(set).filter(Boolean).sort((a,b)=>a-b);
      ROUND.innerHTML = allRounds.map(r=>`<option value="${r}">Ronda ${r}</option>`).join('');
    }
    function renderMatches(){
      const r = Number(ROUND.value);
      const q = norm(Q.value);
      const ids = Object.entries(allPairings)
        .filter(([id,p]) => Number(p.round)===r)
        .filter(([id,p]) => !q || norm(p.white).includes(q) || norm(p.black).includes(q))
        .map(([id])=>id);
      filteredIds = ids;
      MATCH.innerHTML = ids.map(id=>{
        const p = allPairings[id];
        const res = p.result || 'pendiente';
        return `<option value="${id}">${vsLabel(p)}  —  [${res}]</option>`;
      }).join('');
      renderPreview();
    }
    function renderPreview(){
      const id = MATCH.value;
      if(!id){ PREVIEW.textContent = 'Selecciona una partida.'; return; }
      const p = allPairings[id];
      PREVIEW.innerHTML = `
        <div class="kv"><span>Ronda</span> <strong>${p.round}</strong></div>
        <div class="kv"><span>Partida</span> <strong>${vsLabel(p)}</strong></div>
        <div class="kv"><span>Estado</span> <strong>${p.result || 'pendiente'}</strong></div>
        <div class="kv"><span>Última actualización</span> <strong>${p.updatedAt ? new Date(p.updatedAt).toLocaleString() : '—'}</strong></div>
      `;
      G1.value = p.game1 || '';
      G2.value = p.game2 || '';
      G3.value = p.game3 || '';
    }

    // Suscripciones
    onValue(ref(db, 'pairings'), snap => {
      allPairings = snap.val() || {};
      renderRounds();
      renderMatches();
    });

    // Eventos UI
    Q.addEventListener('input', renderMatches);
    ROUND.addEventListener('change', renderMatches);
    MATCH.addEventListener('change', renderPreview);

    // Guardar
    BTN_SAVE.addEventListener('click', async ()=>{
      const id = MATCH.value;
      if(!id) { STATUS.textContent = 'Selecciona una partida.'; return; }
      const g1 = G1.value, g2 = G2.value, g3 = G3.value;
      if(!g1 || !g2 || !g3){
        STATUS.innerHTML = '<span class="status-bad">Debes seleccionar los 3 juegos (G1, G2, G3).</span>';
        return;
      }
      const overall = calcWinner(g1,g2,g3);
      if(!overall){
        STATUS.innerHTML = '<span class="status-bad">Completa todos los juegos para calcular el resultado global.</span>';
        return;
      }
      const payload = {
        game1: g1, game2: g2, game3: g3,
        result: overall,
        updatedAt: Date.now(),
        reportedBy: (REPORTER.value || '').trim() || null,
        note: (NOTE.value || '').trim() || null,
        reporterUid: uid || null
      };
      try{
        await update(ref(db, `pairings/${id}`), payload);
        STATUS.innerHTML = `<span class="status-ok">✔️ Resultado guardado (${overall}).</span>`;
      }catch(e){
        console.error(e);
        STATUS.innerHTML = `<span class="status-bad">Error: ${e.message}</span>`;
      }
    });
  </script>
</body>
</html>
