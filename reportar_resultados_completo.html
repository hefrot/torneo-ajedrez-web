<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportar Resultados - Torneo de Ajedrez</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== IMPORTAR FUENTES ===== */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap');

        /* ===== VARIABLES ===== */
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #151922;
            --bg-card: #1a1f2e;
            --bg-card-hover: #202633;
            --accent-primary: #00d9ff;
            --accent-secondary: #0099cc;
            --accent-glow: rgba(0, 217, 255, 0.3);
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-muted: #5f6368;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #ef4444;
            --info: #60a5fa;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px var(--accent-glow);
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-color: #2d3748;
        }

        /* ===== RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(0, 217, 255, 0.03) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(0, 153, 204, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* ===== HEADER ===== */
        .header {
            position: relative;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, #1a2332 100%);
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            z-index: 10;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }

        .header-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        /* ===== CONTENEDOR ===== */
        .container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
            z-index: 1;
        }

        /* ===== SECCIONES ===== */
        .section {
            margin-bottom: 3rem;
            animation: fadeIn 0.6s ease-out;
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon {
            font-size: 1.5rem;
            color: var(--accent-primary);
        }

        /* ===== TARJETAS ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        /* ===== FORMULARIOS ===== */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Open Sans', sans-serif;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* ===== SISTEMA DE JUEGOS BO3 ===== */
        .games-container {
            display: grid;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .game-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary));
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .game-number {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .game-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .game-status.pending {
            background: rgba(251, 191, 36, 0.15);
            color: var(--warning);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .game-status.completed {
            background: rgba(52, 211, 153, 0.15);
            color: var(--success);
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .game-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }

        .game-btn {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
        }

        .game-btn:hover:not(.selected) {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .game-btn.selected {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: var(--accent-primary);
            color: var(--bg-primary);
            box-shadow: var(--shadow-glow);
        }

        .game-btn-label {
            font-size: 1rem;
        }

        .game-btn-points {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* ===== RESUMEN ===== */
        .summary {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border: 2px solid var(--accent-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .summary-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--accent-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .summary-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ===== BOTONES ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md), var(--shadow-glow);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* ===== ALERTAS ===== */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideDown 0.3s ease-out;
        }

        .alert-success {
            background: rgba(52, 211, 153, 0.15);
            border: 1px solid rgba(52, 211, 153, 0.3);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        .alert-info {
            background: rgba(96, 165, 250, 0.15);
            border: 1px solid rgba(96, 165, 250, 0.3);
            color: var(--info);
        }

        /* ===== RESULTADOS REPORTADOS ===== */
        .results-list {
            display: grid;
            gap: 1rem;
            margin-top: 2rem;
        }

        .result-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }

        .result-info h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .result-details {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .result-detail {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .result-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ===== LOADING ===== */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            gap: 1rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-card);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .hidden {
            display: none !important;
        }

        /* ===== ANIMACIONES ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header-title {
                font-size: 2rem;
            }

            .container {
                padding: 2rem 1rem;
            }

            .game-buttons {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .result-item {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">
                <i class="fas fa-clipboard-check"></i>
                Reportar Resultados
            </h1>
            <p class="header-subtitle">Sistema de Reporte BO3 - Round Robin 21 Rondas</p>
            
            <div class="nav-links">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    Inicio
                </a>
                <a href="tabla.html" class="nav-link">
                    <i class="fas fa-trophy"></i>
                    Tabla de Posiciones
                </a>
                <a href="calendario.html" class="nav-link">
                    <i class="fas fa-calendar"></i>
                    Calendario
                </a>
                <a href="admin.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    Admin
                </a>
            </div>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container">
        <!-- Alertas -->
        <div id="alerts-container"></div>

        <!-- SECCI√ìN: SELECCIONAR ENFRENTAMIENTO -->
        <section class="section">
            <h2 class="section-title">
                <i class="section-icon fas fa-hand-pointer"></i>
                Seleccionar Enfrentamiento
            </h2>
            
            <div class="card">
                <div class="form-group">
                    <label for="select-round" class="form-label">
                        <i class="fas fa-layer-group"></i>
                        Ronda
                    </label>
                    <select id="select-round" class="form-select">
                        <option value="">Selecciona una ronda...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="select-pairing" class="form-label">
                        <i class="fas fa-users"></i>
                        Enfrentamiento
                    </label>
                    <select id="select-pairing" class="form-select">
                        <option value="">Primero selecciona una ronda...</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- SECCI√ìN: REPORTAR JUEGOS (oculta inicialmente) -->
        <section id="report-section" class="section hidden">
            <h2 class="section-title">
                <i class="section-icon fas fa-gamepad"></i>
                Reportar Juegos
            </h2>
            
            <div class="card">
                <div class="games-container" id="games-container">
                    <!-- Los juegos se generar√°n din√°micamente aqu√≠ -->
                </div>

                <!-- Resumen -->
                <div id="summary-container" class="hidden">
                    <div class="summary">
                        <h3 class="summary-title">
                            <i class="fas fa-chart-bar"></i>
                            Resumen del Enfrentamiento
                        </h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Puntos</div>
                                <div class="summary-value" id="summary-player1-points">0</div>
                                <div class="summary-label" id="summary-player1-name">Jugador 1</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Puntos</div>
                                <div class="summary-value" id="summary-player2-points">0</div>
                                <div class="summary-label" id="summary-player2-name">Jugador 2</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Resultado Final</div>
                                <div class="summary-value" id="summary-result">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="btn-group">
                    <button id="btn-save" class="btn btn-primary" disabled>
                        <i class="fas fa-save"></i>
                        Guardar Resultado
                    </button>
                    <button id="btn-cancel" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                </div>
            </div>
        </section>

        <!-- SECCI√ìN: RESULTADOS REPORTADOS -->
        <section class="section">
            <h2 class="section-title">
                <i class="section-icon fas fa-list-check"></i>
                Resultados Reportados Recientemente
            </h2>
            
            <div id="results-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--text-secondary);">Cargando resultados...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, set, update, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ============================================
        // CONFIGURACI√ìN DE FIREBASE
        // ============================================
        // ‚ö†Ô∏è REEMPLAZA ESTO CON TU CONFIGURACI√ìN REAL
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            databaseURL: "TU_DATABASE_URL",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let jugadores = {};
        let rondas = {};
        let currentPairing = null;
        let currentRound = null;
        let gameResults = [null, null, null]; // Resultados de los 3 juegos

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéÆ Sistema de reporte iniciado');
            loadData();
            setupEventListeners();
        });

        // ============================================
        // CARGAR DATOS
        // ============================================
        async function loadData() {
            try {
                // Cargar jugadores
                const jugadoresSnapshot = await get(ref(db, 'jugadores'));
                if (jugadoresSnapshot.exists()) {
                    jugadores = jugadoresSnapshot.val();
                }

                // Cargar rondas
                const rondasSnapshot = await get(ref(db, 'rondas'));
                if (rondasSnapshot.exists()) {
                    rondas = rondasSnapshot.val();
                    populateRoundSelect();
                }

                // Escuchar cambios en resultados
                listenToResults();

            } catch (error) {
                console.error('Error al cargar datos:', error);
                showAlert('Error al cargar datos del torneo', 'error');
            }
        }

        // ============================================
        // POBLAR SELECT DE RONDAS
        // ============================================
        function populateRoundSelect() {
            const select = document.getElementById('select-round');
            select.innerHTML = '<option value="">Selecciona una ronda...</option>';

            // Crear opciones para 21 rondas
            for (let i = 1; i <= 21; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Ronda ${i}`;
                select.appendChild(option);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            document.getElementById('select-round').addEventListener('change', handleRoundChange);
            document.getElementById('select-pairing').addEventListener('change', handlePairingChange);
            document.getElementById('btn-save').addEventListener('click', handleSaveResult);
            document.getElementById('btn-cancel').addEventListener('click', handleCancel);
        }

        // ============================================
        // CAMBIO DE RONDA
        // ============================================
        async function handleRoundChange(e) {
            const roundNum = e.target.value;
            if (!roundNum) {
                document.getElementById('select-pairing').innerHTML = '<option value="">Primero selecciona una ronda...</option>';
                return;
            }

            currentRound = roundNum;

            try {
                const pairingsSnapshot = await get(ref(db, `rondas/ronda${roundNum}/partidos`));
                const pairingSelect = document.getElementById('select-pairing');
                pairingSelect.innerHTML = '<option value="">Selecciona un enfrentamiento...</option>';

                if (pairingsSnapshot.exists()) {
                    const partidos = pairingsSnapshot.val();
                    Object.keys(partidos).forEach(key => {
                        const partido = partidos[key];
                        const player1 = jugadores[partido.jugador1]?.nombre || 'Jugador 1';
                        const player2 = jugadores[partido.jugador2]?.nombre || 'Jugador 2';
                        
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${player1} vs ${player2}`;
                        pairingSelect.appendChild(option);
                    });
                } else {
                    showAlert('No hay enfrentamientos para esta ronda', 'info');
                }
            } catch (error) {
                console.error('Error al cargar enfrentamientos:', error);
                showAlert('Error al cargar enfrentamientos', 'error');
            }
        }

        // ============================================
        // CAMBIO DE ENFRENTAMIENTO
        // ============================================
        async function handlePairingChange(e) {
            const pairingId = e.target.value;
            if (!pairingId || !currentRound) {
                hideReportSection();
                return;
            }

            try {
                const pairingSnapshot = await get(ref(db, `rondas/ronda${currentRound}/partidos/${pairingId}`));
                if (pairingSnapshot.exists()) {
                    currentPairing = {
                        id: pairingId,
                        ...pairingSnapshot.val()
                    };
                    
                    // Cargar resultados existentes si los hay
                    if (currentPairing.juegos) {
                        gameResults = [
                            currentPairing.juegos.juego1 || null,
                            currentPairing.juegos.juego2 || null,
                            currentPairing.juegos.juego3 || null
                        ];
                    } else {
                        gameResults = [null, null, null];
                    }
                    
                    showReportSection();
                }
            } catch (error) {
                console.error('Error al cargar enfrentamiento:', error);
                showAlert('Error al cargar enfrentamiento', 'error');
            }
        }

        // ============================================
        // MOSTRAR SECCI√ìN DE REPORTE
        // ============================================
        function showReportSection() {
            const section = document.getElementById('report-section');
            section.classList.remove('hidden');
            generateGameCards();
            updateSummary();
            
            // Scroll suave a la secci√≥n
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideReportSection() {
            document.getElementById('report-section').classList.add('hidden');
            gameResults = [null, null, null];
            currentPairing = null;
        }

        // ============================================
        // GENERAR TARJETAS DE JUEGOS
        // ============================================
        function generateGameCards() {
            const container = document.getElementById('games-container');
            container.innerHTML = '';

            const player1Name = jugadores[currentPairing.jugador1]?.nombre || 'Jugador 1';
            const player2Name = jugadores[currentPairing.jugador2]?.nombre || 'Jugador 2';

            for (let i = 0; i < 3; i++) {
                const card = document.createElement('div');
                card.className = 'game-card';
                
                const gameNum = i + 1;
                const result = gameResults[i];
                const isCompleted = result !== null;

                card.innerHTML = `
                    <div class="game-header">
                        <div class="game-number">
                            <i class="fas fa-chess"></i>
                            Juego ${gameNum}
                        </div>
                        <div class="game-status ${isCompleted ? 'completed' : 'pending'}">
                            ${isCompleted ? 'Completado' : 'Pendiente'}
                        </div>
                    </div>
                    <div class="game-buttons">
                        <button class="game-btn ${result === 'player1' ? 'selected' : ''}" 
                                data-game="${i}" data-result="player1">
                            <div class="game-btn-label">${player1Name} gan√≥</div>
                            <div class="game-btn-points">+1 punto</div>
                        </button>
                        <button class="game-btn ${result === 'draw' ? 'selected' : ''}" 
                                data-game="${i}" data-result="draw">
                            <div class="game-btn-label">Empate</div>
                            <div class="game-btn-points">+0.5 puntos c/u</div>
                        </button>
                        <button class="game-btn ${result === 'player2' ? 'selected' : ''}" 
                                data-game="${i}" data-result="player2">
                            <div class="game-btn-label">${player2Name} gan√≥</div>
                            <div class="game-btn-points">+1 punto</div>
                        </button>
                    </div>
                `;

                // Event listeners para los botones
                card.querySelectorAll('.game-btn').forEach(btn => {
                    btn.addEventListener('click', handleGameResult);
                });

                container.appendChild(card);
            }
        }

        // ============================================
        // MANEJAR RESULTADO DE JUEGO
        // ============================================
        function handleGameResult(e) {
            const btn = e.currentTarget;
            const gameIndex = parseInt(btn.dataset.game);
            const result = btn.dataset.result;

            // Actualizar resultado
            gameResults[gameIndex] = result;

            // Actualizar UI del juego espec√≠fico
            const gameCard = btn.closest('.game-card');
            gameCard.querySelectorAll('.game-btn').forEach(b => {
                b.classList.remove('selected');
            });
            btn.classList.add('selected');

            // Actualizar status
            const status = gameCard.querySelector('.game-status');
            status.textContent = 'Completado';
            status.classList.remove('pending');
            status.classList.add('completed');

            // Actualizar resumen
            updateSummary();
        }

        // ============================================
        // ACTUALIZAR RESUMEN
        // ============================================
        function updateSummary() {
            const player1Name = jugadores[currentPairing.jugador1]?.nombre || 'Jugador 1';
            const player2Name = jugadores[currentPairing.jugador2]?.nombre || 'Jugador 2';

            // Calcular puntos
            let player1Points = 0;
            let player2Points = 0;

            gameResults.forEach(result => {
                if (result === 'player1') player1Points += 1;
                else if (result === 'player2') player2Points += 1;
                else if (result === 'draw') {
                    player1Points += 0.5;
                    player2Points += 0.5;
                }
            });

            // Actualizar UI
            document.getElementById('summary-player1-name').textContent = player1Name;
            document.getElementById('summary-player2-name').textContent = player2Name;
            document.getElementById('summary-player1-points').textContent = player1Points.toFixed(1);
            document.getElementById('summary-player2-points').textContent = player2Points.toFixed(1);

            // Resultado final
            let finalResult = '-';
            if (gameResults.every(r => r !== null)) {
                if (player1Points > player2Points) {
                    finalResult = `Victoria de ${player1Name}`;
                } else if (player2Points > player1Points) {
                    finalResult = `Victoria de ${player2Name}`;
                } else {
                    finalResult = 'Empate General';
                }
            }
            document.getElementById('summary-result').textContent = finalResult;

            // Mostrar resumen
            document.getElementById('summary-container').classList.remove('hidden');

            // Habilitar bot√≥n de guardar si todos los juegos est√°n reportados
            const allGamesReported = gameResults.every(r => r !== null);
            document.getElementById('btn-save').disabled = !allGamesReported;
        }

        // ============================================
        // GUARDAR RESULTADO
        // ============================================
        async function handleSaveResult() {
            if (!currentPairing || gameResults.some(r => r === null)) {
                showAlert('Debes completar los 3 juegos antes de guardar', 'error');
                return;
            }

            try {
                showAlert('Guardando resultado...', 'info');

                const player1Name = jugadores[currentPairing.jugador1]?.nombre;
                const player2Name = jugadores[currentPairing.jugador2]?.nombre;

                // Calcular puntos totales
                let player1Points = 0;
                let player2Points = 0;

                gameResults.forEach(result => {
                    if (result === 'player1') player1Points += 1;
                    else if (result === 'player2') player2Points += 1;
                    else if (result === 'draw') {
                        player1Points += 0.5;
                        player2Points += 0.5;
                    }
                });

                // Determinar ganador para el sistema 3/1/0
                let player1TournamentPoints = 0;
                let player2TournamentPoints = 0;

                if (player1Points > player2Points) {
                    player1TournamentPoints = 3;
                    player2TournamentPoints = 0;
                } else if (player2Points > player1Points) {
                    player1TournamentPoints = 0;
                    player2TournamentPoints = 3;
                } else {
                    player1TournamentPoints = 1;
                    player2TournamentPoints = 1;
                }

                // Actualizar resultado del partido
                const partidoRef = ref(db, `rondas/ronda${currentRound}/partidos/${currentPairing.id}`);
                await update(partidoRef, {
                    juegos: {
                        juego1: gameResults[0],
                        juego2: gameResults[1],
                        juego3: gameResults[2]
                    },
                    resultado: {
                        jugador1Puntos: player1Points,
                        jugador2Puntos: player2Points,
                        jugador1PuntosTorneo: player1TournamentPoints,
                        jugador2PuntosTorneo: player2TournamentPoints
                    },
                    reportadoEn: Date.now()
                });

                // Actualizar tabla de jugadores
                await updatePlayerStats(
                    currentPairing.jugador1, 
                    player1TournamentPoints, 
                    player1Points > player2Points ? 'win' : player1Points < player2Points ? 'loss' : 'draw'
                );
                
                await updatePlayerStats(
                    currentPairing.jugador2, 
                    player2TournamentPoints, 
                    player2Points > player1Points ? 'win' : player2Points < player1Points ? 'loss' : 'draw'
                );

                showAlert(`‚úÖ Resultado guardado: ${player1Name} ${player1Points}-${player2Points} ${player2Name}`, 'success');

                // Limpiar formulario
                setTimeout(() => {
                    hideReportSection();
                    document.getElementById('select-round').value = '';
                    document.getElementById('select-pairing').value = '';
                }, 2000);

            } catch (error) {
                console.error('Error al guardar resultado:', error);
                showAlert('Error al guardar resultado', 'error');
            }
        }

        // ============================================
        // ACTUALIZAR ESTAD√çSTICAS DE JUGADOR
        // ============================================
        async function updatePlayerStats(playerId, points, result) {
            try {
                const playerRef = ref(db, `jugadores/${playerId}`);
                const playerSnapshot = await get(playerRef);
                
                if (playerSnapshot.exists()) {
                    const player = playerSnapshot.val();
                    const newPoints = (player.puntos || 0) + points;
                    const newGames = (player.partidasJugadas || 0) + 1;
                    
                    let newWins = player.victorias || 0;
                    let newDraws = player.empates || 0;
                    let newLosses = player.derrotas || 0;

                    if (result === 'win') newWins++;
                    else if (result === 'draw') newDraws++;
                    else if (result === 'loss') newLosses++;

                    // Calcular ELO Performance (f√≥rmula simplificada)
                    const winRate = (newWins + (newDraws * 0.5)) / newGames;
                    const eloPerformance = Math.round((player.rating || 1500) + (400 * (winRate - 0.5)));

                    await update(playerRef, {
                        puntos: newPoints,
                        partidasJugadas: newGames,
                        victorias: newWins,
                        empates: newDraws,
                        derrotas: newLosses,
                        eloPerformance: eloPerformance,
                        ultimaActualizacion: Date.now()
                    });
                }
            } catch (error) {
                console.error('Error al actualizar estad√≠sticas:', error);
            }
        }

        // ============================================
        // CANCELAR
        // ============================================
        function handleCancel() {
            if (confirm('¬øCancelar el reporte? Se perder√°n los cambios no guardados.')) {
                hideReportSection();
                document.getElementById('select-round').value = '';
                document.getElementById('select-pairing').value = '';
            }
        }

        // ============================================
        // ESCUCHAR RESULTADOS
        // ============================================
        function listenToResults() {
            const resultsContainer = document.getElementById('results-container');
            
            onValue(ref(db, 'rondas'), (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No hay resultados reportados a√∫n</p>
                        </div>
                    `;
                    return;
                }

                // Recopilar todos los resultados reportados
                const results = [];
                Object.keys(data).forEach(rondaKey => {
                    const ronda = data[rondaKey];
                    if (ronda.partidos) {
                        Object.keys(ronda.partidos).forEach(partidoKey => {
                            const partido = ronda.partidos[partidoKey];
                            if (partido.resultado) {
                                results.push({
                                    ronda: rondaKey,
                                    partidoId: partidoKey,
                                    ...partido
                                });
                            }
                        });
                    }
                });

                // Ordenar por fecha (m√°s reciente primero)
                results.sort((a, b) => (b.reportadoEn || 0) - (a.reportadoEn || 0));

                // Mostrar solo los √∫ltimos 10
                const recentResults = results.slice(0, 10);

                if (recentResults.length === 0) {
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No hay resultados reportados a√∫n</p>
                        </div>
                    `;
                    return;
                }

                // Renderizar resultados
                resultsContainer.innerHTML = '<div class="results-list"></div>';
                const list = resultsContainer.querySelector('.results-list');

                recentResults.forEach(result => {
                    const player1Name = jugadores[result.jugador1]?.nombre || 'Jugador 1';
                    const player2Name = jugadores[result.jugador2]?.nombre || 'Jugador 2';
                    const roundNum = result.ronda.replace('ronda', '');

                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <div class="result-info">
                            <h4>
                                ${player1Name} 
                                <span style="color: var(--accent-primary);">${result.resultado.jugador1Puntos}</span>
                                -
                                <span style="color: var(--accent-primary);">${result.resultado.jugador2Puntos}</span>
                                ${player2Name}
                            </h4>
                            <div class="result-details">
                                <span class="result-detail">
                                    <i class="fas fa-layer-group"></i>
                                    Ronda ${roundNum}
                                </span>
                                <span class="result-detail">
                                    <i class="fas fa-trophy"></i>
                                    ${result.resultado.jugador1PuntosTorneo}-${result.resultado.jugador2PuntosTorneo} puntos
                                </span>
                                <span class="result-detail">
                                    <i class="far fa-clock"></i>
                                    ${new Date(result.reportadoEn).toLocaleString('es-ES')}
                                </span>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button class="btn btn-secondary" onclick="editResult('${result.ronda}', '${result.partidoId}')" 
                                    style="padding: 0.5rem 1rem; font-size: 0.75rem;">
                                <i class="fas fa-edit"></i>
                                Editar
                            </button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }

        // ============================================
        // EDITAR RESULTADO
        // ============================================
        window.editResult = async function(rondaKey, partidoId) {
            const roundNum = rondaKey.replace('ronda', '');
            
            // Establecer ronda
            document.getElementById('select-round').value = roundNum;
            await handleRoundChange({ target: { value: roundNum } });
            
            // Esperar un momento para que se carguen los enfrentamientos
            setTimeout(() => {
                document.getElementById('select-pairing').value = partidoId;
                handlePairingChange({ target: { value: partidoId } });
                
                // Scroll a la secci√≥n
                document.getElementById('report-section').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                
                showAlert('Editando resultado. Modifica los juegos y guarda de nuevo.', 'info');
            }, 500);
        };

        // ============================================
        // SISTEMA DE ALERTAS
        // ============================================
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alerts-container');
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle'
            };
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="${icons[type]}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(alert);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                alert.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // A√±adir animaci√≥n fadeOut
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-10px);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>