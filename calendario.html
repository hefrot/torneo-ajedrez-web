<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calendario • Torneo de Ajedrez</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
  <script defer src="https://kit.fontawesome.com/a2e0e6ad4d.js" crossorigin="anonymous"></script>
  <style>
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    .search{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px 12px;background:rgba(21,29,47,.6)}
    .search input{border:0;outline:none;background:transparent;color:var(--text);min-width:240px}
    .round-block{margin:18px 0;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg, rgba(21,29,47,.9), rgba(21,29,47,.75))}
    .round-title{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)}
    .matches{display:grid;gap:10px;padding:12px}
    .match-row{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;padding:10px 12px;border:1px dashed var(--line);border-radius:12px}
    .names{display:flex;gap:8px;align-items:center;overflow:auto}
    .names a{display:inline-flex;gap:6px;align-items:center}
    .status{font-size:12px; grid-column: 1 / -1; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner container">
      <div class="logo"></div>
      <div class="title">
        <div class="badge">Calendario</div>
        <h1 class="title">Todas las rondas</h1>
      </div>
      <div class="header-stats" style="margin-left:auto">
        <a class="pill" href="./index.html"><i class="fa-solid fa-arrow-left"></i> <span>Volver</span></a>
        <a class="pill" href="./reportar.html"><i class="fa-solid fa-pen-to-square"></i> <span>Reportar</span></a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div class="toolbar">
        <div class="search">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="q" placeholder="Buscar jugador (ej. Mena, Jorge, etc.)" />
        </div>
        <button id="btn-clear" class="btn">Limpiar</button>
        <a class="pill" href="?player=" id="shareLink" target="_blank"><i class="fa-solid fa-share-nodes"></i> Compartir vista</a>
      </div>
      <div id="calendar"></div>
    </section>
  </main>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // === WhatsApp helpers (multi-país) ===
    const COUNTRY_MAP = {
      'MX': '52','MEXICO':'52',
      'AR': '54','ARGENTINA':'54',
      'CL': '56','CHILE':'56',
      'CO': '57','COLOMBIA':'57',
      'PE': '51','PERU':'51','PERÚ':'51',
      'EC': '593','ECUADOR':'593',
      'UY': '598','URUGUAY':'598',
      'PY': '595','PARAGUAY':'595',
      'BO': '591','BOLIVIA':'591',
      'VE': '58','VENEZUELA':'58',
      'CR': '506','COSTA RICA':'506',
      'PA': '507','PANAMA':'507','PANAMÁ':'507',
      'GT': '502','GUATEMALA':'502',
      'SV': '503','EL SALVADOR':'503',
      'HN': '504','HONDURAS':'504',
      'NI': '505','NICARAGUA':'505',
      'BR': '55','BRASIL':'55','BRAZIL':'55',
      'DO': '1','RD':'1','REPUBLICA DOMINICANA':'1','REPÚBLICA DOMINICANA':'1',
      'PR': '1','PUERTO RICO':'1',
      'US': '1','USA':'1','EEUU':'1','ESTADOS UNIDOS':'1',
      'ES': '34','ESPAÑA':'34',
      'CU': '53','CUBA':'53'
    };
    const DEFAULT_COUNTRY_CODE = '52'; // fallback si no hay cc por jugador
    function normCC(raw){
      if(!raw) return null;
      let s = String(raw).trim().toUpperCase();
      if(s.startsWith('+')) s = s.slice(1);
      if(/^\d{1,4}$/.test(s)) return s;
      s = s.normalize('NFD').replace(/\p{Diacritic}/gu,'');
      return COUNTRY_MAP[s] || null;
    }
    function waLink(raw, ccHint){
      if(!raw) return null;
      let s = String(raw).trim();
      if(/^https?:\/\/wa\.me\//i.test(s) || /^https?:\/\/api\.whatsapp\.com\//i.test(s)) return s;
      s = s.replace(/\s|-/g,'');
      if(s.startsWith('00')) s = '+' + s.slice(2);
      if(!s.startsWith('+')){
        let cc = normCC(ccHint) || DEFAULT_COUNTRY_CODE;
        if(/^\d{8,12}$/.test(s)) s = '+' + cc + s.replace(/^0+/,'');
        else return null;
      }
      return 'https://wa.me/' + s.replace('+','');
    }

    // === App ===
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const CAL = document.getElementById('calendar');
    const Q   = document.getElementById('q');
    const BTN_CLEAR = document.getElementById('btn-clear');
    const SHARE = document.getElementById('shareLink');

    let calendario = {};   // { ronda1: [ ... ] }
    let pairings = [];     // arr de pairings publicados
    let roster = {};       // name -> {whatsapp, cc}
    let filtro = "";

    const params = new URLSearchParams(location.search);
    const playerParam = params.get('player');
    if (playerParam) { Q.value = playerParam; filtro = playerParam; }

    function norm(s){ return String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }

    // Carga roster para obtener WhatsApp/cc por jugador
    onValue(ref(db,'jugadores'), snap => {
      const obj = snap.val() || {};
      roster = {};
      Object.values(obj).forEach(p=>{
        const name = p.nombre || p.name || p.nombreCompleto;
        if(!name) return;
        roster[name] = {
          whatsapp: p.whatsapp || p.telefono || null,
          cc: p.countryCode || p.cc || p.pais || p.country || null
        };
      });
      render();
    });

    onValue(ref(db,'calendario'), snap => { calendario = snap.val() || {}; render(); });
    onValue(ref(db,'pairings'), snap => { const obj = snap.val() || {}; pairings = Object.values(obj); render(); });

    function matchResultFor(round, p1, p2){
      const n1 = norm(p1), n2 = norm(p2);
      for (const m of pairings) {
        if (Number(m.round) !== Number(round)) continue;
        const a = norm(m.white), b = norm(m.black);
        const same = ( (a===n1 && b===n2) || (a===n2 && b===n1) );
        if (same) return m;
      }
      return null;
    }

    function render(){
      CAL.innerHTML = '';
      const rounds = Object.keys(calendario)
        .filter(k => /^ronda\d+$/i.test(k))
        .sort((a,b)=> Number(a.replace(/\D/g,'')) - Number(b.replace(/\D/g,'')));

      rounds.forEach(key => {
        const r = Number(key.replace(/\D/g,''));
        const matches = calendario[key]||[];
        const fm = filtro ? matches.filter(m => {
          const n1 = norm(m.p1_name), n2 = norm(m.p2_name);
          return n1.includes(norm(filtro)) || n2.includes(norm(filtro));
        }) : matches;

        if (fm.length === 0) return;

        const block = document.createElement('div');
        block.className = 'round-block';

        const head = document.createElement('div');
        head.className = 'round-title';
        head.innerHTML = `<h3>Ronda ${r}</h3><div class="badge">${fm.length} partidas</div>`;
        block.appendChild(head);

        const list = document.createElement('div');
        list.className = 'matches';

        fm.forEach(m => {
          const p = matchResultFor(r, m.p1_name, m.p2_name);
          const row = document.createElement('div');
          row.className = 'match-row';

          // Preferimos wa de pairing si vienen; si no, del roster
          const leftRoster  = roster[m.p1_name] || {};
          const rightRoster = roster[m.p2_name] || {};
          const leftWA  = p?.whiteWhatsapp || leftRoster.whatsapp || null;
          const rightWA = p?.blackWhatsapp || rightRoster.whatsapp || null;
          const w1 = waLink(leftWA,  leftRoster.cc);
          const w2 = waLink(rightWA, rightRoster.cc);

          const g1 = p?.game1 || '—', g2 = p?.game2 || '—', g3 = p?.game3 || '—';
          const resText = p?.result ? (p.result==='white' ? `Ganó ${m.p1_name}` : p.result==='black' ? `Ganó ${m.p2_name}` : 'Tablas') : 'Pendiente';

          row.innerHTML = `
            <div class="names">
              ${w1 ? `<a class="btn" target="_blank" rel="noopener" href="${w1}"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
              <span>${m.p1_name}</span>
            </div>
            <div class="muted">vs</div>
            <div class="names">
              <span>${m.p2_name}</span>
              ${w2 ? `<a class="btn" target="_blank" rel="noopener" href="${w2}"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
            </div>
            <div class="status">
              <div class="muted">J1: <strong>${g1}</strong> • J2: <strong>${g2}</strong> • J3: <strong>${g3}</strong></div>
              <div>${resText}</div>
            </div>
          `;

          list.appendChild(row);
        });

        block.appendChild(list);
        CAL.appendChild(block);
      });
    }

    Q.addEventListener('input', () => { filtro = Q.value.trim(); SHARE.href = `?player=${encodeURIComponent(filtro)}`; render(); });
    BTN_CLEAR.addEventListener('click', () => { Q.value = ''; filtro = ''; SHARE.href = `?player=`; render(); });
    SHARE.href = `?player=${encodeURIComponent(Q.value||'')}`;
  </script>
</body>
</html>
