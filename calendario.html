<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calendario ‚Ä¢ Torneo de Ajedrez</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
  <script defer src="https://kit.fontawesome.com/a2e0e6ad4d.js" crossorigin="anonymous"></script>
  <style>
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    .search{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px 14px;background:rgba(21,29,47,.6)}
    .search input{border:0;outline:none;background:transparent;color:var(--text);min-width:240px}
    .round-block{margin:18px 0;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg, rgba(21,29,47,.9), rgba(21,29,47,.75));overflow:hidden}
    .round-title{position:sticky;top:64px;z-index:2;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);backdrop-filter:blur(6px);cursor:pointer}
    .round-title h3{display:flex;align-items:center;gap:10px;margin:0}
    .round-title .chev{transition:transform .22s ease}
    .round-title[data-open="false"] .chev{transform:rotate(-90deg)}
    .round-title .meta{display:flex;gap:8px;align-items:center}
    .matches{display:grid;gap:10px;padding:12px}
    .match-row{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center;padding:12px 14px;border:1px dashed var(--line);border-radius:12px;transition:transform .12s ease, box-shadow .12s ease}
    .match-row:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .names{display:flex;gap:10px;align-items:center;overflow:auto}
    .flag{font-size:18px}
    .user-pill{font-size:12px;border:1px solid var(--line);padding:4px 8px;border-radius:999px;opacity:.9}
    .user-pill i{margin-right:6px}
    .wa-btn{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.15)}
    .status{grid-column:1/-1;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;font-size:13px}
    .game-chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-weight:600}
    .chip.white{color:var(--text)}
    .chip.black{color:var(--text)}
    .chip.draw{color:var(--muted)}
    .chip.na{color:var(--muted)}
    @media (max-width:720px){
      .match-row{grid-template-columns:1fr;gap:6px}
      .status{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner container">
      <div class="logo"></div>
      <div class="title">
        <div class="badge">Calendario</div>
        <h1 class="title">Todas las rondas</h1>
      </div>
      <div class="header-stats" style="margin-left:auto">
        <a class="pill" href="./index.html"><i class="fa-solid fa-arrow-left"></i> <span>Volver</span></a>
        <a class="pill" href="./reportar.html"><i class="fa-solid fa-pen-to-square"></i> <span>Reportar</span></a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div class="toolbar">
        <div class="search">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="q" placeholder="Buscar jugador (ej. Mena, Jorge, etc.)" />
        </div>
        <button id="btn-clear" class="btn">Limpiar</button>
        <a class="pill" href="?player=" id="shareLink" target="_blank"><i class="fa-solid fa-share-nodes"></i> Compartir vista</a>
      </div>
      <div id="calendar"></div>
    </section>
  </main>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // helpers
    
// Country helpers
const COUNTRY_TO_DIAL = {
  MX:'52', AR:'54', CL:'56', CO:'57', PE:'51', EC:'593', UY:'598', PY:'595', BO:'591', VE:'58',
  CR:'506', PA:'507', GT:'502', SV:'503', HN:'504', NI:'505', BR:'55', DO:'1', RD:'1', PR:'1',
  US:'1', USA:'1', ES:'34', CU:'53'
};
const NAME_TO_ISO = {
  'MEXICO':'MX','M√âXICO':'MX','ARGENTINA':'AR','CHILE':'CL','COLOMBIA':'CO','PERU':'PE','PER√ö':'PE','ECUADOR':'EC',
  'URUGUAY':'UY','PARAGUAY':'PY','BOLIVIA':'BO','VENEZUELA':'VE','COSTA RICA':'CR','PANAMA':'PA','PANAM√Å':'PA',
  'GUATEMALA':'GT','EL SALVADOR':'SV','HONDURAS':'HN','NICARAGUA':'NI','BRASIL':'BR','BRAZIL':'BR',
  'REPUBLICA DOMINICANA':'DO','REP√öBLICA DOMINICANA':'DO','PUERTO RICO':'PR','ESTADOS UNIDOS':'US','ESPA√ëA':'ES','CUBA':'CU'
};
const DIAL_TO_ISO = Object.fromEntries(Object.entries(COUNTRY_TO_DIAL).map(([iso,dial])=>[dial,iso]));
const DEFAULT_DIAL = '52'; // fallback if player has no country
const A_FLAG = 0x1F1E6;

const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');

function resolveISO(raw){
  if(!raw) return null;
  let s = String(raw).trim().toUpperCase();
  if (s.startsWith('+')) s = s.slice(1);
  if (/^[A-Z]{2}$/.test(s)) return s; // ISO2 direct
  const s2 = s.normalize('NFD').replace(/\p{Diacritic}/gu,'');
  if (NAME_TO_ISO[s2]) return NAME_TO_ISO[s2];
  if (/^\d{1,4}$/.test(s)) return DIAL_TO_ISO[s] || null; // dial to ISO
  return null;
}

function isoToFlag(iso){
  if(!iso || iso.length!==2) return 'üè≥Ô∏è';
  const a = iso.charCodeAt(0)-65, b = iso.charCodeAt(1)-65;
  return String.fromCodePoint(A_FLAG+a) + String.fromCodePoint(A_FLAG+b);
}

function lichessLink(user){
  if(!user) return null;
  const u = String(user).replace(/^@/,'').trim();
  if(!u) return null;
  return `https://lichess.org/@/${u}`;
}

function waLink(raw, isoHint){
  if(!raw) return null;
  let s = String(raw).trim();
  if(/^https?:\/\/(wa\.me|api\.whatsapp\.com)\//i.test(s)) return s;
  s = s.replace(/\s|-/g,'');
  if (s.startsWith('00')) s = '+'+s.slice(2);
  if (!s.startsWith('+')){
    const iso = resolveISO(isoHint);
    const dial = iso ? COUNTRY_TO_DIAL[iso] : DEFAULT_DIAL;
    if (/^\d{8,12}$/.test(s)) s = '+' + (dial||DEFAULT_DIAL) + s.replace(/^0+/,''); else return null;
  }
  return 'https://wa.me/' + s.replace('+','');
}

function esc(s){
  return String(s||'').replace(/[&<>\"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}


    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const CAL = document.getElementById('calendar');
    const Q   = document.getElementById('q');
    const BTN_CLEAR = document.getElementById('btn-clear');
    const SHARE = document.getElementById('shareLink');

    let calendario = {}, pairings = [], roster = {};
    const params = new URLSearchParams(location.search);
    const playerParam = params.get('player'); if (playerParam) Q.value = playerParam;

    onValue(ref(db,'jugadores'), snap=>{
      const obj = snap.val()||{};
      roster = {};
      for(const p of Object.values(obj)){
        const name = p.nombre || p.name || p.nombreCompleto;
        if(!name) continue;
        const iso = resolveISO(p.countryISO || p.pais || p.country || p.countryCode || p.cc);
        roster[name] = {
          whatsapp: p.whatsapp || p.telefono || null,
          iso: iso || null,
          lichess: p.lichess || p.lichessUser || p.lichess_username || null
        };
      }
      render();
    });
    onValue(ref(db,'calendario'), snap=>{ calendario = snap.val()||{}; render(); });
    onValue(ref(db,'pairings'),   snap=>{ const obj = snap.val()||{}; pairings = Object.values(obj||{}); render(); });

    function findPair(round, a, b){
      const A = norm(a), B = norm(b);
      return pairings.find(m=> Number(m.round)===Number(round) && (
        (norm(m.white)===A && norm(m.black)===B) || (norm(m.white)===B && norm(m.black)===A)
      )) || null;
    }
    function chip(v){
      if(v==='white') return `<span class="chip white">1‚Äì0 (blancas)</span>`;
      if(v==='black') return `<span class="chip black">0‚Äì1 (negras)</span>`;
      if(v==='draw')  return `<span class="chip draw">¬Ω‚Äì¬Ω</span>`;
      return `<span class="chip na">‚Äî</span>`;
    }

    function render(){
      const q = norm(Q.value);
      CAL.innerHTML = '';
      const rounds = Object.keys(calendario).filter(k=>/^ronda\d+$/i.test(k))
        .sort((a,b)=> Number(a.replace(/\D/g,'')) - Number(b.replace(/\D/g,'')));

      rounds.forEach((key,idx)=>{
        const r = Number(key.replace(/\D/g,''));
        const matches = calendario[key]||[];
        const filtered = q ? matches.filter(m=> norm(m.p1_name).includes(q)||norm(m.p2_name).includes(q) ) : matches;
        if(!filtered.length) return;

        const block = document.createElement('div');
        block.className = 'round-block';

        const head = document.createElement('div');
        head.className = 'round-title';
        head.dataset.open = (idx<2 ? 'true' : 'false');
        head.innerHTML = `<h3><span class="chev">‚ñæ</span> Ronda ${r}</h3>
          <div class="meta"><span class="badge">${filtered.length} partidas</span>
          <span class="pill"><i class="fa-regular fa-eye"></i> <span>${head.dataset.open==='true'?'Mostrando':'Oculta'}</span></span></div>`;
        block.appendChild(head);

        const list = document.createElement('div');
        list.className = 'matches';
        list.style.display = (head.dataset.open==='true'?'grid':'none');
        head.addEventListener('click',()=>{
          const open = head.dataset.open === 'true';
          head.dataset.open = open ? 'false' : 'true';
          list.style.display = open ? 'none':'grid';
          head.querySelector('.pill span').textContent = open ? 'Oculta':'Mostrando';
        });

        filtered.forEach(m=>{
          const p = findPair(r, m.p1_name, m.p2_name);
          const left  = roster[m.p1_name] || {};
          const right = roster[m.p2_name] || {};
          const linkL = waLink(p?.whiteWhatsapp || left.whatsapp,  left.iso);
          const linkR = waLink(p?.blackWhatsapp || right.whatsapp, right.iso);
          const flagL = isoToFlag(left.iso||''), flagR = isoToFlag(right.iso||'');
          const lichL = left.lichess  ? `<a class="user-pill" target="_blank" href="${lichessLink(left.lichess)}"><i class="fa-brands fa-lichess"></i>@${esc(String(left.lichess).replace(/^@/,''))}</a>` : '';
          const lichR = right.lichess ? `<a class="user-pill" target="_blank" href="${lichessLink(right.lichess)}"><i class="fa-brands fa-lichess"></i>@${esc(String(right.lichess).replace(/^@/,''))}</a>` : '';

          const g1 = p?.game1 || null, g2 = p?.game2 || null, g3 = p?.game3 || null;
          const status = p?.result ? (p.result==='white' ? `Gan√≥ ${m.p1_name}` : p.result==='black' ? `Gan√≥ ${m.p2_name}` : 'Tablas') : 'Pendiente';

          const row = document.createElement('div');
          row.className = 'match-row';
          row.innerHTML = `
            <div class="names">
              <span class="flag">${flagL}</span>
              <strong>${m.p1_name}</strong>
              ${lichL}
              ${linkL? `<a class="wa-btn" target="_blank" rel="noopener" href="${linkL}" title="WhatsApp ${m.p1_name}"><i class="fa-brands fa-whatsapp"></i></a>`:''}
            </div>
            <div class="muted">vs</div>
            <div class="names" style="justify-content:flex-end">
              ${linkR? `<a class="wa-btn" target="_blank" rel="noopener" href="${linkR}" title="WhatsApp ${m.p2_name}"><i class="fa-brands fa-whatsapp"></i></a>`:''}
              ${lichR}
              <strong>${m.p2_name}</strong>
              <span class="flag">${flagR}</span>
            </div>
            <div class="status">
              <div class="game-chips">${chip(g1)} ${chip(g2)} ${chip(g3)}</div>
              <div class="badge">${status}</div>
            </div>`;
          list.appendChild(row);
        });

        block.appendChild(list);
        CAL.appendChild(block);
      });
    }

    const updateShare = () => SHARE.href = `?player=${encodeURIComponent(Q.value||'')}`;
    Q.addEventListener('input', ()=>{ updateShare(); render(); });
    BTN_CLEAR.addEventListener('click', ()=>{ Q.value=''; updateShare(); render(); });
    updateShare();
  </script>
</body>
</html>
