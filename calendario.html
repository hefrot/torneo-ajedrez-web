<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calendario • Torneo de Ajedrez</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
  <script defer src="https://kit.fontawesome.com/a2e0e6ad4d.js" crossorigin="anonymous"></script>
  <style>
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    .search{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px 12px;background:rgba(21,29,47,.6)}
    .search input{border:0;outline:none;background:transparent;color:var(--text);min-width:240px}
    .round-block{margin:18px 0;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg, rgba(21,29,47,.9), rgba(21,29,47,.75))}
    .round-title{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)}
    .matches{display:grid;gap:10px;padding:12px}
    .match-row{display:grid;grid-template-columns:1fr auto 1fr auto;gap:10px;align-items:center;padding:10px 12px;border:1px dashed var(--line);border-radius:12px}
    .match-row .names{display:flex;gap:8px;align-items:center;overflow:auto}
    .status{font-size:12px}
    .result.win{color:var(--win)}
    .result.loss{color:var(--loss)}
    .result.draw{color:var(--draw)}
    .muted{color:var(--muted)}
    .pill-link{border:1px solid var(--line);padding:6px 10px;border-radius:999px}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner container">
      <div class="logo"></div>
      <div class="title">
        <div class="badge">Calendario</div>
        <h1 class="title">Todas las rondas</h1>
      </div>
      <div class="header-stats" style="margin-left:auto">
        <a class="pill" href="./index.html"><i class="fa-solid fa-arrow-left"></i> <span>Volver</span></a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div class="toolbar">
        <div class="search">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="q" placeholder="Buscar jugador (ej. Mena, Jorge, etc.)" />
        </div>
        <button id="btn-clear" class="btn">Limpiar</button>
        <a class="pill-link" href="?player=" id="shareLink" target="_blank">Compartir vista del jugador</a>
      </div>
      <div id="calendar"></div>
    </section>
  </main>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const CAL = document.getElementById('calendar');
    const Q   = document.getElementById('q');
    const BTN_CLEAR = document.getElementById('btn-clear');
    const SHARE = document.getElementById('shareLink');

    let calendario = {};   // { ronda1: [ ... ], ... }
    let pairings = [];     // publicados (con resultados)
    let filtro = "";       // texto de búsqueda

    const params = new URLSearchParams(location.search);
    const playerParam = params.get('player');
    if (playerParam) {
      Q.value = playerParam;
      filtro = playerParam;
    }

    function norm(s){ return String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }

    function matchResultFor(round, p1, p2){
      // busca resultado en pairings publicados de la misma ronda (ignorando colores)
      const n1 = norm(p1), n2 = norm(p2);
      for (const m of pairings) {
        if (Number(m.round) !== Number(round)) continue;
        const a = norm(m.white), b = norm(m.black);
        const same = ( (a===n1 && b===n2) || (a===n2 && b===n1) );
        if (same) return m.result || 'pendiente';
      }
      return 'pendiente';
    }

    function waLink(raw){
      if(!raw) return null;
      let num = String(raw).replace(/\s|-/g,'');
      return num.startsWith('+') ? `https://wa.me/${num.replace('+','')}` : null;
    }

    function render(){
      CAL.innerHTML = '';
      // ordenar rondas por número
      const rounds = Object.keys(calendario)
        .filter(k => /^ronda\d+$/i.test(k))
        .sort((a,b)=> Number(a.replace(/\D/g,'')) - Number(b.replace(/\D/g,'')));

      rounds.forEach(key => {
        const r = Number(key.replace(/\D/g,''));
        const matches = calendario[key]||[];

        // filtra por jugador si aplica
        const fm = filtro ? matches.filter(m => {
          const n1 = norm(m.p1_name), n2 = norm(m.p2_name);
          return n1.includes(norm(filtro)) || n2.includes(norm(filtro));
        }) : matches;

        if (fm.length === 0) return;

        const block = document.createElement('div');
        block.className = 'round-block';

        const head = document.createElement('div');
        head.className = 'round-title';
        head.innerHTML = `<h3>Ronda ${r}</h3><div class="badge">${fm.length} partidas</div>`;
        block.appendChild(head);

        const list = document.createElement('div');
        list.className = 'matches';

        fm.forEach(m => {
          const res = matchResultFor(r, m.p1_name, m.p2_name);
          let statusHTML = `<span class="muted">pendiente</span>`;
          if (res === 'white') statusHTML = `<span class="result win">Ganó ${m.p1_name}</span>`;
          else if (res === 'black') statusHTML = `<span class="result win">Ganó ${m.p2_name}</span>`;
          else if (res === 'draw') statusHTML = `<span class="result draw">Tablas</span>`;

          const row = document.createElement('div');
          row.className = 'match-row';
          const wa1 = waLink(m.p1_whatsapp);
          const wa2 = waLink(m.p2_whatsapp);
          row.innerHTML = `
            <div class="names"><i class="fa-regular fa-chess-king"></i> ${m.p1_name}</div>
            <div class="muted">vs</div>
            <div class="names">${m.p2_name} <i class="fa-regular fa-chess-queen"></i></div>
            <div class="status">${statusHTML}</div>
            ${wa1 ? `<a class="btn" target="_blank" rel="noopener" href="${wa1}"><i class="fa-brands fa-whatsapp"></i> ${m.p1_name.split(' ')[0]}</a>`:''}
            <div></div>
            ${wa2 ? `<a class="btn" target="_blank" rel="noopener" href="${wa2}"><i class="fa-brands fa-whatsapp"></i> ${m.p2_name.split(' ')[0]}</a>`:''}
            <div></div>
          `;
          list.appendChild(row);
        });

        block.appendChild(list);
        CAL.appendChild(block);
      });
    }

    onValue(ref(db,'calendario'), snap => {
      calendario = snap.val() || {};
      render();
    });

    onValue(ref(db,'pairings'), snap => {
      const obj = snap.val() || {};
      pairings = Object.values(obj);
      render();
    });

    Q.addEventListener('input', () => {
      filtro = Q.value.trim();
      SHARE.href = `?player=${encodeURIComponent(filtro)}`;
      render();
    });
    BTN_CLEAR.addEventListener('click', () => {
      Q.value = '';
      filtro = '';
      SHARE.href = `?player=`;
      render();
    });

    // para compartir link directo del jugador cargado por parámetro
    SHARE.href = `?player=${encodeURIComponent(Q.value||'')}`;
  </script>
</body>
</html>
