<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla de Posiciones - Torneo Round Robin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#0a0e1a;--bg-secondary:#151922;--bg-card:#1a1f2e;--bg-card-hover:#202633;--accent-primary:#00d9ff;--accent-secondary:#0099cc;--accent-glow:rgba(0,217,255,0.3);--text-primary:#e8eaed;--text-secondary:#9aa0a6;--text-muted:#5f6368;--success:#34d399;--warning:#fbbf24;--danger:#ef4444;--shadow-sm:0 2px 4px rgba(0,0,0,0.3);--shadow-md:0 4px 12px rgba(0,0,0,0.4);--shadow-lg:0 8px 24px rgba(0,0,0,0.5);--shadow-glow:0 0 20px var(--accent-glow);--border-radius:12px;--border-color:#2d3748}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Open Sans',sans-serif;background:var(--bg-primary);color:var(--text-primary);line-height:1.6;min-height:100vh}
        body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%,rgba(0,217,255,0.03) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(0,153,204,0.03) 0%,transparent 50%);pointer-events:none;z-index:0}
        .header{position:relative;background:linear-gradient(135deg,var(--bg-secondary) 0%,#1a2332 100%);padding:2rem 0;border-bottom:1px solid var(--border-color);box-shadow:var(--shadow-md);z-index:10}
        .header-content{max-width:1400px;margin:0 auto;padding:0 2rem;text-align:center}
        .header-title{font-family:'Montserrat',sans-serif;font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,var(--accent-primary) 0%,var(--accent-secondary) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:0.5rem}
        .header-subtitle{font-size:1rem;color:var(--text-secondary);font-weight:300}
        .nav-links{display:flex;justify-content:center;gap:1rem;margin-top:1.5rem;flex-wrap:wrap}
        .nav-link{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:var(--bg-card);color:var(--text-primary);text-decoration:none;border-radius:8px;font-size:0.875rem;font-weight:600;border:1px solid var(--border-color);transition:all 0.3s ease}
        .nav-link:hover{background:var(--bg-card-hover);border-color:var(--accent-primary);transform:translateY(-2px)}
        .container{position:relative;max-width:1400px;margin:0 auto;padding:3rem 2rem;z-index:1}
        .section{margin-bottom:3rem;animation:fadeIn 0.6s ease-out}
        .section-title{font-family:'Montserrat',sans-serif;font-size:1.75rem;font-weight:700;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem}
        .section-icon{font-size:1.5rem;color:var(--accent-primary)}
        .controls{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap;align-items:center}
        .search-box{flex:1;min-width:250px;position:relative}
        .search-input{width:100%;padding:0.875rem 1rem 0.875rem 3rem;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-family:'Open Sans',sans-serif;font-size:0.875rem;transition:all 0.3s ease}
        .search-input:focus{outline:none;border-color:var(--accent-primary);box-shadow:0 0 0 3px var(--accent-glow)}
        .search-icon{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--text-muted)}
        .sort-buttons{display:flex;gap:0.5rem;flex-wrap:wrap}
        .btn-sort{display:inline-flex;align-items:center;gap:0.5rem;padding:0.75rem 1rem;background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color);border-radius:8px;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.3s ease}
        .btn-sort:hover{background:var(--bg-card-hover);border-color:var(--accent-primary)}
        .btn-sort.active{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:var(--bg-primary);border-color:var(--accent-primary);box-shadow:var(--shadow-glow)}
        .table-container{background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--border-radius);overflow-x:auto;box-shadow:var(--shadow-md)}
        table{width:100%;border-collapse:collapse}
        thead{background:var(--bg-secondary);position:sticky;top:0;z-index:5}
        th{padding:1rem;text-align:left;font-family:'Montserrat',sans-serif;font-weight:700;font-size:0.875rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-secondary);border-bottom:2px solid var(--border-color);white-space:nowrap}
        th.sortable{cursor:pointer;user-select:none;transition:color 0.3s ease}
        th.sortable:hover{color:var(--accent-primary)}
        tbody tr{border-bottom:1px solid var(--border-color);transition:all 0.3s ease}
        tbody tr:hover{background:var(--bg-card-hover)}
        tbody tr.top-1{background:linear-gradient(90deg,rgba(255,215,0,0.1) 0%,transparent 100%)}
        tbody tr.top-2{background:linear-gradient(90deg,rgba(192,192,192,0.1) 0%,transparent 100%)}
        tbody tr.top-3{background:linear-gradient(90deg,rgba(205,127,50,0.1) 0%,transparent 100%)}
        td{padding:1rem;font-size:0.875rem;color:var(--text-primary)}
        .rank-cell{font-family:'Montserrat',sans-serif;font-weight:700;font-size:1rem}
        .rank-badge{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;font-weight:700;font-size:0.875rem}
        .rank-badge.gold{background:linear-gradient(135deg,#ffd700,#ffed4e);color:#0a0e1a;box-shadow:0 0 15px rgba(255,215,0,0.4)}
        .rank-badge.silver{background:linear-gradient(135deg,#c0c0c0,#e8e8e8);color:#0a0e1a;box-shadow:0 0 15px rgba(192,192,192,0.4)}
        .rank-badge.bronze{background:linear-gradient(135deg,#cd7f32,#e8a87c);color:#0a0e1a;box-shadow:0 0 15px rgba(205,127,50,0.4)}
        .rank-badge.normal{background:var(--bg-secondary);color:var(--text-primary);border:2px solid var(--border-color)}
        .player-name{font-family:'Montserrat',sans-serif;font-weight:600;display:flex;align-items:center;gap:0.5rem}
        .flag{font-size:1.25rem}
        .stat-highlight{font-family:'Montserrat',sans-serif;font-weight:700;color:var(--accent-primary)}
        .record{font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem}
        .loading{display:flex;flex-direction:column;align-items:center;padding:3rem;gap:1rem}
        .spinner{width:48px;height:48px;border:4px solid var(--bg-card);border-top-color:var(--accent-primary);border-radius:50%;animation:spin 0.8s linear infinite}
        .empty-state{text-align:center;padding:3rem;color:var(--text-muted)}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media (max-width:768px){.header-title{font-size:2rem}.container{padding:2rem 1rem}.controls{flex-direction:column}.search-box{min-width:100%}.sort-buttons{width:100%;justify-content:center}.table-container{font-size:0.75rem}th,td{padding:0.75rem 0.5rem}th{font-size:0.75rem}td{font-size:0.75rem}.player-name{flex-direction:column;align-items:flex-start}}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">
                <i class="fas fa-trophy"></i>
                Tabla de Posiciones
            </h1>
            <p class="header-subtitle">Clasificación Completa - Sistema 3/1/0</p>
            <div class="nav-links">
                <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Inicio</a>
                <a href="calendario.html" class="nav-link"><i class="fas fa-calendar"></i> Calendario</a>
                <a href="reportar.html" class="nav-link"><i class="fas fa-clipboard-check"></i> Reportar</a>
                <a href="admin.html" class="nav-link"><i class="fas fa-cog"></i> Admin</a>
            </div>
        </div>
    </header>

    <div class="container">
        <section class="section">
            <h2 class="section-title">
                <i class="section-icon fas fa-list-ol"></i>
                Clasificación General
            </h2>

            <div class="controls">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search-input" class="search-input" placeholder="Buscar jugador...">
                </div>
                <div class="sort-buttons">
                    <button class="btn-sort active" data-sort="puntos">
                        <i class="fas fa-trophy"></i> Puntos
                    </button>
                    <button class="btn-sort" data-sort="wins">
                        <i class="fas fa-star"></i> Victorias
                    </button>
                    <button class="btn-sort" data-sort="rating">
                        <i class="fas fa-chess"></i> Rating
                    </button>
                    <button class="btn-sort" data-sort="games">
                        <i class="fas fa-gamepad"></i> Partidas
                    </button>
                </div>
            </div>

            <div id="table-container">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-qg8pD2OMjzOR5iwH_xIYVrwKlckCYGg",
            authDomain: "hmena-torneo-bc215.firebaseapp.com",
            databaseURL: "https://hmena-torneo-bc215-default-rtdb.firebaseio.com",
            projectId: "hmena-torneo-bc215",
            storageBucket: "hmena-torneo-bc215.firebasestorage.app",
            messagingSenderId: "843984319871",
            appId: "1:843984319871:web:3193a4c5d949b72616564a"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let jugadores = [];
        let currentSort = 'puntos';
        let searchTerm = '';

        // Cargar datos
        onValue(ref(db, 'jugadores'), (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                jugadores = Object.entries(data).map(([id, j]) => ({ id, ...j }));
                renderTable();
            } else {
                document.getElementById('table-container').innerHTML = '<div class="empty-state"><i class="fas fa-users-slash" style="font-size:3rem;margin-bottom:1rem"></i><p>No hay jugadores registrados</p></div>';
            }
        });

        // Event listeners
        document.getElementById('search-input').addEventListener('input', (e) => {
            searchTerm = e.target.value.toLowerCase().trim();
            renderTable();
        });

        document.querySelectorAll('.btn-sort').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.btn-sort').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                currentSort = e.currentTarget.dataset.sort;
                renderTable();
            });
        });

        function renderTable() {
            let filtered = jugadores;

            // Filtrar por búsqueda
            if (searchTerm) {
                filtered = filtered.filter(j => 
                    j.nombre.toLowerCase().includes(searchTerm)
                );
            }

            // Ordenar
            filtered.sort((a, b) => {
                if (currentSort === 'puntos') {
                    if (b.puntos !== a.puntos) return (b.puntos || 0) - (a.puntos || 0);
                    if (b.wins !== a.wins) return (b.wins || 0) - (a.wins || 0);
                    const ratingA = a.eloActual ?? a.elo ?? 1000;
                    const ratingB = b.eloActual ?? b.elo ?? 1000;
                    return ratingB - ratingA;
                } else if (currentSort === 'wins') {
                    if (b.wins !== a.wins) return (b.wins || 0) - (a.wins || 0);
                    return (b.puntos || 0) - (a.puntos || 0);
                } else if (currentSort === 'rating') {
                    const ratingA = a.eloActual ?? a.elo ?? 1000;
                    const ratingB = b.eloActual ?? b.elo ?? 1000;
                    return ratingB - ratingA;
                } else if (currentSort === 'games') {
                    if (b.games !== a.games) return (b.games || 0) - (a.games || 0);
                    return (b.puntos || 0) - (a.puntos || 0);
                }
                return 0;
            });

            const container = document.getElementById('table-container');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-search" style="font-size:3rem;margin-bottom:1rem"></i><p>No se encontraron jugadores</p></div>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Jugador</th>
                                <th class="sortable">Puntos</th>
                                <th class="sortable">Rating</th>
                                <th class="sortable">Partidas</th>
                                <th class="sortable">Victorias</th>
                                <th class="sortable">Empates</th>
                                <th class="sortable">Derrotas</th>
                                <th>ELO Perf.</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            filtered.forEach((j, idx) => {
                const rank = idx + 1;
                const rankClass = rank === 1 ? 'top-1' : rank === 2 ? 'top-2' : rank === 3 ? 'top-3' : '';
                const badgeClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : 'normal';
                const rating = j.eloActual ?? j.elo ?? 1000;
                const flag = getFlag(j.whatsapp);

                html += `
                    <tr class="${rankClass}">
                        <td class="rank-cell">
                            <div class="rank-badge ${badgeClass}">${rank}</div>
                        </td>
                        <td>
                            <div class="player-name">
                                ${flag}
                                <span>${escapeHtml(j.nombre)}</span>
                            </div>
                            <div class="record">${j.games || 0} partidas</div>
                        </td>
                        <td><span class="stat-highlight">${j.puntos || 0}</span></td>
                        <td>${rating}</td>
                        <td>${j.games || 0}</td>
                        <td><span style="color:var(--success)">${j.wins || 0}</span></td>
                        <td><span style="color:var(--warning)">${j.draws || 0}</span></td>
                        <td><span style="color:var(--danger)">${j.losses || 0}</span></td>
                        <td>${j.eloPerformance || rating}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function getFlag(whatsapp) {
            if (!whatsapp) return '';
            const prefixes = {
                '+52': '🇲🇽', '+54': '🇦🇷', '+56': '🇨🇱', '+57': '🇨🇴',
                '+58': '🇻🇪', '+51': '🇵🇪', '+55': '🇧🇷', '+53': '🇨🇺',
                '+593': '🇪🇨', '+595': '🇵🇾', '+598': '🇺🇾', '+591': '🇧🇴',
                '+1': '🇺🇸', '+34': '🇪🇸'
            };
            for (let [prefix, flag] of Object.entries(prefixes)) {
                if (whatsapp.startsWith(prefix)) return `<span class="flag">${flag}</span>`;
            }
            return '';
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
