<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo Round Robin - Inicio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #151922;
            --bg-card: #1a1f2e;
            --bg-card-hover: #202633;
            --accent-primary: #00d9ff;
            --accent-secondary: #0099cc;
            --accent-glow: rgba(0, 217, 255, 0.3);
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-muted: #5f6368;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #ef4444;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px var(--accent-glow);
            --border-radius: 12px;
            --border-color: #2d3748;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(0, 217, 255, 0.03) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(0, 153, 204, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .header {
            position: relative;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, #1a2332 100%);
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            z-index: 10;
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }
        .header-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        .header-subtitle { font-size: 1rem; color: var(--text-secondary); font-weight: 300; }
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }
        .container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
            z-index: 1;
        }
        .section {
            margin-bottom: 3rem;
            animation: fadeIn 0.6s ease-out;
        }
        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .section-icon { font-size: 1.5rem; color: var(--accent-primary); }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }
        .card:hover::before { transform: scaleX(1); }
        .player-card {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1rem;
            align-items: center;
        }
        .player-rank {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--bg-primary);
            box-shadow: var(--shadow-sm);
        }
        .player-rank.top-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }
        .player-rank.top-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            box-shadow: 0 0 20px rgba(192, 192, 192, 0.4);
        }
        .player-rank.top-3 {
            background: linear-gradient(135deg, #cd7f32, #e8a87c);
            box-shadow: 0 0 20px rgba(205, 127, 50, 0.4);
        }
        .player-info { flex: 1; }
        .player-name {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .player-details {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .player-detail {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        .pairing-card {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .pairing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .pairing-round {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--accent-primary);
            font-size: 0.875rem;
        }
        .pairing-match {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
        }
        .pairing-player {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .pairing-player-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .flag {
            font-size: 1.25rem;
        }
        .pairing-player-rating {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .pairing-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        .social-links {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .social-link {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.75rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .social-link:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }
        .social-link.whatsapp { border-color: #25d366; color: #25d366; }
        .social-link.whatsapp:hover { background: rgba(37, 211, 102, 0.1); }
        .social-link.lichess { border-color: var(--text-secondary); }
        .social-link.lichess:hover { border-color: #fff; color: #fff; }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 3rem;
            gap: 1rem;
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-card);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .header-title { font-size: 2rem; }
            .container { padding: 2rem 1rem; }
            .cards-grid { grid-template-columns: 1fr; }
            .pairing-match { grid-template-columns: 1fr; gap: 0.75rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">
                <i class="fas fa-chess"></i>
                Torneo Round Robin
            </h1>
            <p class="header-subtitle">Sistema BO3 - 21 Rondas</p>
            <div class="nav-links">
                <a href="calendario.html" class="nav-link">
                    <i class="fas fa-calendar"></i> Calendario
                </a>
                <a href="reportar.html" class="nav-link">
                    <i class="fas fa-clipboard-check"></i> Reportar
                </a>
                <a href="tabla.html" class="nav-link">
                    <i class="fas fa-trophy"></i> Tabla
                </a>
                <a href="admin.html" class="nav-link">
                    <i class="fas fa-cog"></i> Admin
                </a>
            </div>
        </div>
    </header>

    <div class="container">
        <section class="section">
            <h2 class="section-title">
                <i class="section-icon fas fa-crown"></i>
                Top 10 - ClasificaciÃ³n
            </h2>
            <div id="ranking-container">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="section-icon fas fa-chess-board"></i>
                Pareos Ronda Actual
            </h2>
            <div id="pareos-container">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-qg8pD2OMjzOR5iwH_xIYVrwKlckCYGg",
            authDomain: "hmena-torneo-bc215.firebaseapp.com",
            databaseURL: "https://hmena-torneo-bc215-default-rtdb.firebaseio.com",
            projectId: "hmena-torneo-bc215",
            storageBucket: "hmena-torneo-bc215.firebasestorage.app",
            messagingSenderId: "843984319871",
            appId: "1:843984319871:web:3193a4c5d949b72616564a"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let jugadores = {};
        let currentRound = 1;

        // Cargar datos
        onValue(ref(db, 'jugadores'), (snapshot) => {
            if (snapshot.exists()) {
                jugadores = snapshot.val();
                renderRanking();
            }
        });

        onValue(ref(db, 'tournament/currentRound'), (snapshot) => {
            if (snapshot.exists()) {
                currentRound = snapshot.val();
                loadPareos();
            }
        });

        function renderRanking() {
            const container = document.getElementById('ranking-container');
            const jugadoresArray = Object.entries(jugadores).map(([id, data]) => ({
                id,
                ...data
            }));

            jugadoresArray.sort((a, b) => {
                if (b.puntos !== a.puntos) return b.puntos - a.puntos;
                if (b.wins !== a.wins) return b.wins - a.wins;
                const ratingA = a.eloActual ?? a.elo ?? 1000;
                const ratingB = b.eloActual ?? b.elo ?? 1000;
                return ratingB - ratingA;
            });

            const top10 = jugadoresArray.slice(0, 10);

            if (top10.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-users-slash" style="font-size: 3rem; margin-bottom: 1rem;"></i><p>No hay jugadores registrados</p></div>';
                return;
            }

            let html = '<div class="cards-grid">';
            top10.forEach((j, idx) => {
                const rank = idx + 1;
                const rankClass = rank === 1 ? 'top-1' : rank === 2 ? 'top-2' : rank === 3 ? 'top-3' : '';
                const rating = j.eloActual ?? j.elo ?? 1000;
                const flag = getFlag(j.whatsapp);

                html += `
                    <div class="card player-card">
                        <div class="player-rank ${rankClass}">${rank}</div>
                        <div class="player-info">
                            <div class="player-name">
                                ${flag} ${escapeHtml(j.nombre)}
                            </div>
                            <div class="player-details">
                                <span class="player-detail">
                                    <i class="fas fa-trophy" style="color: var(--accent-primary);"></i>
                                    <strong>${j.puntos || 0}</strong> pts
                                </span>
                                <span class="player-detail">
                                    <i class="fas fa-star" style="color: var(--warning);"></i>
                                    ${rating}
                                </span>
                                <span class="player-detail">
                                    <i class="fas fa-chess" style="color: var(--text-muted);"></i>
                                    ${j.games || 0}G/${j.wins || 0}V/${j.draws || 0}E/${j.losses || 0}D
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function loadPareos() {
            onValue(ref(db, `rondas/ronda${currentRound}/partidos`), (snapshot) => {
                renderPareos(snapshot.val());
            });
        }

        function renderPareos(partidos) {
            const container = document.getElementById('pareos-container');
            if (!partidos) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-chess-board" style="font-size: 3rem; margin-bottom: 1rem;"></i><p>No hay pareos publicados para esta ronda</p></div>';
                return;
            }

            let html = '<div class="cards-grid">';
            Object.entries(partidos).forEach(([id, partido]) => {
                const j1 = jugadores[partido.jugador1];
                const j2 = jugadores[partido.jugador2];
                if (!j1 || !j2) return;

                const r1 = j1.eloActual ?? j1.elo ?? 1000;
                const r2 = j2.eloActual ?? j2.elo ?? 1000;
                const flag1 = getFlag(j1.whatsapp);
                const flag2 = getFlag(j2.whatsapp);

                html += `
                    <div class="card pairing-card">
                        <div class="pairing-header">
                            <div class="pairing-round">
                                <i class="fas fa-layer-group"></i>
                                Ronda ${currentRound}
                            </div>
                        </div>
                        <div class="pairing-match">
                            <div class="pairing-player">
                                <div class="pairing-player-name">
                                    ${flag1} ${escapeHtml(j1.nombre)}
                                </div>
                                <div class="pairing-player-rating">${r1} ELO</div>
                                <div class="social-links">
                                    ${j1.whatsapp ? `<a href="${getWhatsAppLink(j1.whatsapp)}" target="_blank" class="social-link whatsapp"><i class="fab fa-whatsapp"></i> WhatsApp</a>` : ''}
                                    ${j1.lichess ? `<a href="${getLichessLink(j1.lichess)}" target="_blank" class="social-link lichess"><i class="fas fa-chess-knight"></i> @Lichess</a>` : ''}
                                </div>
                            </div>
                            <div class="pairing-vs">VS</div>
                            <div class="pairing-player">
                                <div class="pairing-player-name">
                                    ${flag2} ${escapeHtml(j2.nombre)}
                                </div>
                                <div class="pairing-player-rating">${r2} ELO</div>
                                <div class="social-links">
                                    ${j2.whatsapp ? `<a href="${getWhatsAppLink(j2.whatsapp)}" target="_blank" class="social-link whatsapp"><i class="fab fa-whatsapp"></i> WhatsApp</a>` : ''}
                                    ${j2.lichess ? `<a href="${getLichessLink(j2.lichess)}" target="_blank" class="social-link lichess"><i class="fas fa-chess-knight"></i> @Lichess</a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function getFlag(whatsapp) {
            if (!whatsapp) return '';
            const prefixes = {
                '+52': 'ðŸ‡²ðŸ‡½', '+54': 'ðŸ‡¦ðŸ‡·', '+56': 'ðŸ‡¨ðŸ‡±', '+57': 'ðŸ‡¨ðŸ‡´',
                '+58': 'ðŸ‡»ðŸ‡ª', '+51': 'ðŸ‡µðŸ‡ª', '+55': 'ðŸ‡§ðŸ‡·', '+53': 'ðŸ‡¨ðŸ‡º',
                '+593': 'ðŸ‡ªðŸ‡¨', '+595': 'ðŸ‡µðŸ‡¾', '+598': 'ðŸ‡ºðŸ‡¾', '+591': 'ðŸ‡§ðŸ‡´',
                '+1': 'ðŸ‡ºðŸ‡¸', '+34': 'ðŸ‡ªðŸ‡¸'
            };
            for (let [prefix, flag] of Object.entries(prefixes)) {
                if (whatsapp.startsWith(prefix)) return `<span class="flag">${flag}</span>`;
            }
            return '';
        }

        function getWhatsAppLink(whatsapp) {
            const clean = whatsapp.replace(/[\s\-\+]/g, '');
            if (clean.length >= 6 && clean.length <= 15 && /^\d+$/.test(clean)) {
                return `https://wa.me/${clean}`;
            }
            return '#';
        }

        function getLichessLink(lichess) {
            const username = lichess.replace('@', '');
            return `https://lichess.org/@/${username}`;
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
